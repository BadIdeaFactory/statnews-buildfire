<!DOCTYPE html>
<html>
<head>
	<meta name="viewport" content="width=device-width, initial-scale=1.0">
	<!-- The BuildFire JS library is required. -->
	<script src="../../../scripts/buildfire.min.js"></script>
	<!-- The Auth0 SPA library is used for authentication negotiation. -->
	<script src="https://cdn.auth0.com/js/auth0-spa-js/1.9/auth0-spa-js.production.js"></script>
	<style type="text/css">
		#bif-sso__wrapper {
			padding: 1em;
		}

		#bif-sso__banner {
			background-color: #222;
			color: white;
			text-align: center;
			padding: 0.5em;
			text-transform: uppercase;
			font-size: 0.9em;
			font-weight: 500;
			margin: 0;
		}

		.bif-sso__content {
			display: none;
		}
		.uninitialized #bif-sso__content--uninitialized,
		.unauthenticated #bif-sso__content--unauthenticated,
		.authenticated #bif-sso__content--authenticated {
			display: initial;
		}

		#bif-sso__alert-message {
			padding: 1em;
			background-color: #ffd;
		}
		#bif-sso__alert-message:empty {
			padding: 0;
		}
		.bif-sso__alert-message--success {
			color: #00b500;
		}
		.bif-sso__alert-message--error {
			color: #ec0000;
		}
	</style>
</head>
<body class="uninitialized">

	<div id="bif-sso__banner">Widget - SSO</div>

	<div id="bif-sso__wrapper">
		<div id="bif-sso__alert-message"></div>

		<ul>
			<!-- <li><a href="https://www.apple.com/">Apple</a></li>
			<li><a href="https://www.statnews.com/">STAT News</a></li>
			<li><a href="https://www.statnews.com/" target="_new">STAT News TARGET NEW</a></li>
			<li><button id="testLinkOpen">window.location=</button></li>
			<li><button id="testLinkWriter">write/click link</button></li> -->
			<!-- <li><button id="testDeeplink">Fetch deeplink</button></li> -->
			<!-- <li><button id="testLoginWithPopup">Login with popup</button></li> -->
			<li><button id="testLoginWithRedirect">Login with redirect</button></li>
			<li><button id="testLogout">Logout</button></li>
		</ul>
		<div id="testLinkWriterDiv"></div>

		<!-- <iframe id="testiframe" width="200" height="200" style="border:1px solid purple"></iframe> -->

		<div id="bif-sso__content--uninitialized" class="bif-sso__content">
			<p>Initializing...</p>
		</div>

		<div id="bif-sso__content--unauthenticated" class="bif-sso__content">
			<p>Click the button below to authenticate.</p>
			<button id="bif-sso__login-button">Log In</button>
		</div>

		<div id="bif-sso__content--authenticated" class="bif-sso__content">
			<p>Successfully authenticated!</p>
			<button id="temp__log-out">Log out</button>
		</div>

	</div>

	<script type="text/javascript">
		// ((window) => {
		// 	window.location.assign('http://www.apple.com')
		// 	window = window.originalWindow
		// })({
		// 	originalWindow: window,
		// 	location: {
		// 		assign: (url) => {
		// 			console.log(`Assigning ${url}`)
		// 			const $div = document.getElementById('testLinkWriterDiv')
		// 			const linkNode = document.createElement('A')
		// 			linkNode.setAttribute('href', url)
		// 			linkNode.setAttribute('target', '_self')
		// 			linkNode.innerHTML = 'Click me'
		// 			$div.appendChild(linkNode)
		// 			const event = document.createEvent('HTMLEvents')
		// 			event.initEvent('click', true, false)
		// 			linkNode.dispatchEvent(event)
		// 		}
		// 	}
		// })

		const ready = (fn) => {
			if (document.readyState != 'loading') fn()
			else document.addEventListener('DOMContentLoaded', fn)
		}

		const $alertMessage = document.getElementById('bif-sso__alert-message')

		const alertMessage = (message, messageType = 'notification') => {
			const filteredClassNames = $alertMessage.className
				.split(' ')
				.filter((className) => !className.startsWith('bif-sso__alert-message--'))
			if (message) filteredClassNames.push(`bif-sso__alert-message--${messageType}`)
			$alertMessage.className = filteredClassNames.join(' ').trim()
			$alertMessage.innerHTML = message
		}

		ready(() => {

			document.getElementById('testLogout').addEventListener('click', (e) => {
				e.preventDefault()
				createAuth0Client({
					domain: 'dev-1dt-zksl.auth0.com',
					client_id: 'gA2H459FJ6Ra5HLuuzib89nqfKoWaMgY',
				})
					.then(auth0 => auth0.logout({
						returnTo: window.location.href
					}))
			})

			const params = new URLSearchParams(window.location.search)
			if (params.get('code') && params.get('state')) {
				alertMessage('Yes we have code/state')
				createAuth0Client({
					domain: 'dev-1dt-zksl.auth0.com',
					client_id: 'gA2H459FJ6Ra5HLuuzib89nqfKoWaMgY',
				}).then(auth0 => {
					alertMessage('about to handleRedirectCallback')
					auth0.handleRedirectCallback()
						.then((response) => {
							auth0.getTokenSilently()
								.then((token) => alertMessage(`Logged in with token ${token}`))
								.catch((error) => alertMessage(error, 'error'))
						})
						.catch((error) => alertMessage(error, 'error'))
				})
			} else {
				// Do nothing in this scope
				((window) => {
					alertMessage('Awaiting click.')
					document.getElementById('testLoginWithRedirect').addEventListener('click', (e) => {
						e.preventDefault()

						alertMessage('About to createAuth0Client')

						createAuth0Client({
							domain: 'dev-1dt-zksl.auth0.com',
							client_id: 'gA2H459FJ6Ra5HLuuzib89nqfKoWaMgY',
						})
							.then(auth0 => {
								alertMessage('About to check isAuthenticated')
								auth0.isAuthenticated()
									.then((isAuthenticated) => {
										if (isAuthenticated) {
											alertMessage('Authenticated!')
										} else {
											// const redirect_uri = `${window.originalWindow.location.origin}${window.originalWindow.location.pathname}`
											const redirect_uri = window.originalWindow.location.href
											alertMessage(`About to loginWithRedirect to ${redirect_uri}`)
											auth0.loginWithRedirect({ redirect_uri })
												// .then(() => alertMessage(`Done logging in, about to redirect to ${redirect_uri}`))
												// .catch((error) => alertMessage(error, 'error'))
											window = window.originalWindow
										}
									})
							})
					})
				})({
					originalWindow: window,
					location: {
						assign: (url) => {
							alertMessage(`Assigning ${url}`)
							const $div = document.getElementById('testLinkWriterDiv')
							const linkNode = document.createElement('A')
							linkNode.setAttribute('href', url)
							linkNode.setAttribute('target', '_self')
							linkNode.innerHTML = 'Click me'
							$div.appendChild(linkNode)
							const event = document.createEvent('HTMLEvents')
							event.initEvent('click', true, false)
							linkNode.dispatchEvent(event)
						}
					}
				})
			}
		})
	</script>
</body>
</html>