<!DOCTYPE html>
<html>
<head>
	<meta name="viewport" content="width=device-width, initial-scale=1.0">
	<!-- The BuildFire JS library is required. -->
	<script src="../../../../scripts/buildfire.min.js"></script>
	<style type="text/css">
		#bif-stat__wrapper {
			padding: 1em;
		}

		.bif-stat__form {
			margin-bottom: 2em;
		}

		.form-control-group {
			margin: 0.5em 0;
		}
		.form-control-group label {
			font-weight: bold;
			display: inline-block;
			text-align: right;
			width: 7em;
			margin-right: 0.25em
		}
		.form-control-group.align-with-labels {
			padding-left: 7.25em;
		}

		form.disabled {
			opacity: 0.5;
			cursor: not-allowed;
		}

		.bif-stat__alert-message--success {
			color: #00b500;
		}
		.bif-stat__alert-message--error {
			color: #ec0000;
		}
	</style>
</head>
<body>

	<div id="bif-stat__wrapper">
		<form id="bif-stat__auth-api-settings" class="bif-stat__form">
			<fieldset>
				<legend>Auth0 API Settings</legend>
				<div class="form-control-group">
					<label for="bif-stat__auth-api-settings__domain">Domain</label>
					<input id="bif-stat__auth-api-settings__domain" type="text">
				</div>
				<div class="form-control-group">
					<label for="bif-stat__auth-api-settings__client-id">Client ID</label>
					<input id="bif-stat__auth-api-settings__client-id" type="text">
				</div>
				<div class="form-control-group align-with-labels">
					<button type="submit" class="btn btn-primary">Save settings</button>
					<span id="bif-stat__auth-api-settings__alert-message" class="bif-stat__alert-message"></span>
				</div>
			</fieldset>
		</form>
		<form id="bif-stat__feed-api" class="bif-stat__form">
			<fieldset>
				<legend>STAT+ RSS Feed Credentials</legend>
				<div class="form-control-group">
					<label for="bif-stat__feed-api__username">Username</label>
					<input id="bif-stat__feed-api__username" type="text">
				</div>
				<div class="form-control-group">
					<label for="bif-stat__feed-api__password">Password</label>
					<input id="bif-stat__feed-api__password" type="text">
				</div>
				<div class="form-control-group align-with-labels">
					<button type="submit" class="btn btn-primary">Save settings</button>
					<span id="bif-stat__feed-api__alert-message" class="bif-stat__alert-message"></span>
				</div>
			</fieldset>
		</form>
	</div>

	<script type="text/javascript">
		// ============================================================================================
		// UTILITY METHODS
		// ============================================================================================

		/**
		 * Runs the provided function when the document is fully loaded.
		 *
		 * @param {Function} fn The function to be run.
		 */
		const ready = (fn) => {
			if (document.readyState != 'loading') fn()
			else document.addEventListener('DOMContentLoaded', fn)
		}

		/**
		 * Determines if the provided object contains the provided key.
		 *
		 * @param {Object} obj The object to test for a given key
		 * @param {String} key The key name to search for
		 */
		const hasKey = (obj, key) => Object.keys(obj).includes(key)

		/**
		 * Enables the provided form element and all its form element children.
		 *
		 * Forms themselves can't be "disabled", so we just remove any previously-set `disabled` class.
		 * Form element children have their `disabled` property set to `false`.
		 *
		 * @param {HTMLElement} $form The form element to enable.
		 */
		const enableForm = ($form) => {
			const $formElements = $form.querySelectorAll('input, textarea, select, button')
			$form.classList.remove('disabled')
			$formElements.forEach(($el) => $el.disabled = false)
		}

		/**
		 * Disables the provided form element and all its form element children.
		 *
		 * Forms themselves can't be "disabled", so we just add a `disabled` class. Form element
		 * children actually their `disabled` property set to `true`.
		 *
		 * @param {HTMLElement} $form The form element to disable.
		 */
		const disableForm = ($form) => {
			const $formElements = $form.querySelectorAll('input, textarea, select, button')
			$form.classList.add('disabled')
			$formElements.forEach(($el) => $el.disabled = true)
		}

		// ============================================================================================
		// APPLICATION METHODS
		// ============================================================================================

		const formSections = {
			'authApi': {
				datastoreKey: 'bif__stat-settings__auth-api',
				$form: document.getElementById('bif-stat__auth-api-settings'),
				$message: document.getElementById('bif-stat__auth-api-settings__alert-message'),
				fields: {
					$domain: document.getElementById('bif-stat__auth-api-settings__domain'),
					$clientId: document.getElementById('bif-stat__auth-api-settings__client-id'),
				},
				messages: {
					'invalid': 'Please provide a valid domain and client ID.'
				},
				validate: (settings) => (settings && settings.domain && settings.clientId),
				prefill: (settings) => {
					formSections.authApi.fields.$domain.value = settings.domain || ''
					formSections.authApi.fields.$clientId.value = settings.clientId || ''
				},
				getValues: () => ({
					domain: formSections.authApi.fields.$domain.value || '',
					clientId: formSections.authApi.fields.$clientId.value || '',
				}),
				handleFormSubmit: (e) => {
					e.preventDefault()
					handleFormSubmit('authApi')
				},
			},
			'feedApi': {
				datastoreKey: 'bif__stat-settings__feed-api',
				$form: document.getElementById('bif-stat__feed-api'),
				$message: document.getElementById('bif-stat__feed-api__alert-message'),
				fields: {
					$username: document.getElementById('bif-stat__feed-api__username'),
					$password: document.getElementById('bif-stat__feed-api__password'),
				},
				messages: {
					'invalid': 'Please provide a valid username and password.'
				},
				validate: (settings) => (settings && settings.username && settings.password),
				prefill: (settings) => {
					formSections.feedApi.fields.$username.value = settings.username || ''
					formSections.feedApi.fields.$password.value = settings.password || ''
				},
				getValues: () => ({
					username: formSections.feedApi.fields.$username.value || '',
					password: formSections.feedApi.fields.$password.value || '',
				}),
				handleFormSubmit: (e) => {
					e.preventDefault()
					handleFormSubmit('feedApi')
				},
			},
		}

		/**
		 * Updates the specified alert message with the provided message and type.
		 *
		 * Expected types are "error" or "success". Default is "notification" and has no special style.
		 *
		 * @param {DOMElement} $messageElement The message element
		 * @param {String}     message         The message that should be displayed.
		 * @param {String}     messageType?    The message type, from the list above.
		 */
		const setAlertMessage = ($messageElement, message, messageType = 'notification') => {
			const filteredClassNames = $messageElement.className.split(' ')
				.filter((className) => !className.startsWith('bif-stat__alert-message--'))
			if (message) filteredClassNames.push(`bif-stat__alert-message--${messageType}`)
			$messageElement.className = filteredClassNames.join(' ').trim()
			$messageElement.innerHTML = message
		}

		/**
		 * Syntactic sugar for clearing any existing alert message by setting it to blank.
		 *
		 * @param {DOMElement} $messageElement The message element
		 */
		const clearAlertMessage = ($messageElement) => setAlertMessage($messageElement, '')

		/**
		 * Saves the settings to the remote BuildFire datastore.
		 *
		 * TODO: Make this a Promise, probably.
		 *
		 * @param {String} formName Internal name of the target form (see reference list above)
		 * @param {Object} settings An object containing the settings.
		 */
		const saveSettings = (formName, settings) => {
			if (!hasKey(formSections, formName)) return false

			const context = formSections[formName]

			disableForm(context.$form)
			buildfire.datastore.save(settings, context.datastoreKey, (err, status) => {
				enableForm(context.$form)
				if (err || !status) setAlertMessage(context.$message, 'Unable to save settings', 'error')
				else setAlertMessage(context.$message, 'Settings saved!', 'success')
			})
		}

		/**
		 * Abstract handler for form submissions.
		 *
		 * This doesn't receive the submission event directly; that's handled by the individual
		 * handlers in the `formSections` object definition. Those should always cancel the native
		 * form submission before calling this.
		 */
		const handleFormSubmit = (formName) => {
			if (!hasKey(formSections, formName)) return false

			const context = formSections[formName]

			const settings = context.getValues()
			if (context.validate(settings)) saveSettings(formName, settings)
			else setAlertMessage(context.$message, context.messages.invalid, 'error')
		}

		/**
		 * Gets the settings for the indicated form from the BuildFire datastore.
		 *
		 * Unlike the widget version, we don't validate the settings here. If they're invalid, we just
		 * won't prefill the form; we don't need to reject the Promise because of it.
		 *
		 * @param {String} formName Name of the target form (must be valid `formSections` key)
		 * @returns {Promise} Resolves with the settings object, rejects with an error message.
		 */
		const fetchSettings = (formName) => new Promise((resolve, reject) => {
			if (!hasKey(formSections, formName)) reject(`Form section ${formName} is not configured.`)

			buildfire.datastore.get(formSections[formName].datastoreKey, (err, data) => {
				if (err) reject(`Could not fetch ${formName} settings.`)
				else resolve(data.data)
			})
		})

		/**
		 * Initializes the specified form, including adding the form submission handler, fetching
		 * existing settings from the datastore, and prefilling the forms if the existing settings
		 * pass validation.
		 *
		 * @param {String} formName Name of the target form (must be valid `formSections` key)
		 */
		const initForm = (formName) => {
			if (!hasKey(formSections, formName)) return false

			const context = formSections[formName]

			context.$form.addEventListener('submit', context.handleFormSubmit)

			fetchSettings(formName)
				.then((settings) => {
					if (context.validate(settings)) context.prefill(settings)
				})
				.catch((error) => setAlertMessage(context.$message, error, 'error'))
		}


		// ============================================================================================
		// INIT/START
		// ============================================================================================

		ready(() => {
			initForm('authApi')
			initForm('feedApi')
		})
	</script>
</body>
</html>
